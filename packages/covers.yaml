automation:
  - alias: ðŸªŸ Close covers at night
    initial_state: true
    trigger:
      platform: sun
      event: sunset
      offset: '00:30:00'
    action:
      - service: cover.close_cover
        entity_id:
          - cover.velux_mezzanine
          - cover.bedroom_blind
      - condition: state
        entity_id: binary_sensor.windows_open
        state: 'off'
      - service: cover.close_cover
        entity_id:
          - cover.office_blind
          - cover.living_room_blind

  - alias: ðŸªŸ  Open mains rooms covers during the day
    initial_state: true
    trigger:
      platform: sun
      event: sunrise
    condition:
      - condition: state
        entity_id: group.guests
        state: 'not_home'
    action:
      - wait_template: "{{ is_state_attr('sensor.lightlevel_70', 'daylight', True) }}"
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.dark_sky_daytime_high_apparent_temperature_0d
                below: 25
            sequence:
              service: cover.open_cover
              entity_id:
                - cover.velux_mezzanine
                - cover.living_room_blind
                - cover.office_blind
        default:
          - service: cover.set_cover_position
            entity_id:
              - cover.living_room_blind
              - cover.office_blind
            data:
              position: 50

  - alias: ðŸªŸ  Open bedroom cover during the day
    initial_state: true
    trigger:
      platform: sun
      event: sunrise
    condition:
      - condition: state
        entity_id: group.people
        state: 'not_home'
      - condition: numeric_state
        entity_id: sensor.dark_sky_daytime_high_apparent_temperature_0d
        below: 25
    action:
      service: cover.open_cover
      entity_id: cover.bedroom_blind

  - alias: ðŸªŸ  Open office blinds during the day
    initial_state: false
    trigger:
      platform: sun
      event: sunrise
    condition:
      - condition: numeric_state
        entity_id: sensor.dark_sky_daytime_high_apparent_temperature_0d
        below: 25
    action:
      service: cover.open_cover
      entity_id: cover.office_blind

  - alias: ðŸªŸ  Toggle bedroom cover
    trigger:
      platform: event
      event_type: deconz_event
      event_data:
        id: bouton_lit
        event: 1005
    action:
      service: cover.toggle
      entity_id: cover.bedroom_blind

  - alias: ðŸªŸ  Open office cover with switch
    trigger:
      platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_open_close_switch
        event: 1002
    action:
      service: cover.open_cover
      entity_id: cover.office_blind
  - alias: Close office cover with switch
    trigger:
      platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_open_close_switch
        event: 2002
    action:
      service: cover.close_cover
      entity_id: cover.office_blind

  - alias: ðŸªŸ  Open living room covers with switch
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_open_close_switch_2
          event: 1002
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_remote_control
          event: 2002
    action:
      service: cover.open_cover
      entity_id:
        - cover.living_room_blind
        - cover.velux_mezzanine
  - alias: Close living room covers with switch
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_open_close_switch_2
          event: 2002
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_remote_control
          event: 3002
    action:
      service: cover.close_cover
      entity_id:
        - cover.living_room_blind
        - cover.velux_mezzanine

cover:
  # Custom device for controlling velux exterior blinds:
  # https://github.com/reefab/homeassistant-velux
  - platform: mqtt
    name: "Velux Mezzanine"
    command_topic: "cmnd/velux/Backlog"
    payload_open: "power2 off; power1 on; delay 1500"
    payload_close: "power1 off; power2 on; delay 320"
    payload_stop: "power1 off; power2 off"
    availability_topic: "tele/velux/LWT"
    payload_available: "Online"
    payload_not_available: "Offline"
  - platform: template
    covers:
      office_blind:  # Template over Ikea blinds controlled via deconz because it doesn't remember its position
        friendly_name: "Store Bureau"
        optimistic: true
        open_cover:
          service: cover.open_cover
          data:
            entity_id: cover.store_bureau
        close_cover:
          service: cover.close_cover
          data:
            entity_id: cover.store_bureau
        set_cover_position:
          service: cover.set_cover_position
          data_template:
            entity_id: cover.store_bureau
            position: "{{position}}"
        stop_cover:
          service: cover.stop_cover
          data:
            entity_id: cover.store_bureau
      living_room_blind:  # Template over Ikea blinds controlled via deconz because it doesn't remember its position
        friendly_name: "Store Salon"
        optimistic: true
        open_cover:
          - service: cover.set_cover_position
            data:
              entity_id: cover.window_covering_device_25
              position: 100
        close_cover:
          service: cover.set_cover_position
          data:
            entity_id: cover.window_covering_device_25
            position: 0
        set_cover_position:
          service: cover.set_cover_position
          data_template:
            entity_id: cover.window_covering_device_25
            position: "{{position}}"
        stop_cover:
          service: cover.stop_cover
          data:
            entity_id: cover.window_covering_device_25

homeassistant:
  customize:
    cover.bedroom_blind:
      device_class: 'blind'
      friendly_name: "Store Chambre"
    cover.velux_mezzanine:
      device_class: 'blind'
    cover.office_blind:
      device_class: 'blind'
    cover.living_room_blind:
      device_class: 'blind'
