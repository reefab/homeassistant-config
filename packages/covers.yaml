automation:
  - alias: ðŸªŸ Close covers at night
    initial_state: true
    trigger:
      platform: sun
      event: sunset
      offset: '00:30:00'
    action:
      - service: cover.close_cover
        entity_id:
          - cover.velux_mezzanine
          - cover.bedroom_blind
      - condition: state
        entity_id: binary_sensor.windows_open
        state: 'off'
      - service: cover.close_cover
        entity_id:
          - cover.windows

  - alias: ðŸªŸ  Open mains rooms covers during the day
    initial_state: true
    trigger:
      platform: sun
      event: sunrise
    condition:
      - condition: state
        entity_id: group.guests
        state: 'not_home'
    action:
      - wait_template: "{{ is_state_attr('sensor.lightlevel_70', 'daylight', True) }}"
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.dark_sky_daytime_high_apparent_temperature_0d
                below: 25
            sequence:
              service: cover.open_cover
              entity_id:
                - cover.velux_mezzanine
                - cover.windows
        default:
          - service: cover.set_cover_position
            entity_id:
              - cover.windows
            data:
              position: 50

  - alias: ðŸªŸ  Open bedroom cover during the day
    initial_state: true
    trigger:
      platform: sun
      event: sunrise
    condition:
      - condition: state
        entity_id: group.people
        state: 'not_home'
      - condition: numeric_state
        entity_id: sensor.dark_sky_daytime_high_apparent_temperature_0d
        below: 25
    action:
      service: cover.open_cover
      entity_id: cover.bedroom_blind

  - alias: ðŸªŸ  Open office blinds during the day
    initial_state: false
    trigger:
      platform: sun
      event: sunrise
    condition:
      - condition: numeric_state
        entity_id: sensor.dark_sky_daytime_high_apparent_temperature_0d
        below: 25
    action:
      service: cover.open_cover
      entity_id: cover.store_bureau

  - alias: ðŸªŸ  Toggle bedroom cover
    trigger:
      platform: event
      event_type: deconz_event
      event_data:
        id: bouton_lit
        event: 1005
    action:
      service: cover.toggle
      entity_id: cover.bedroom_blind

  - alias: ðŸªŸ  Open office cover with switch
    trigger:
      platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_open_close_switch
        event: 1002
    action:
      service: cover.open_cover
      entity_id: cover.store_bureau
  - alias: Close office cover with switch
    trigger:
      platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_open_close_switch
        event: 2002
    action:
      service: cover.close_cover
      entity_id: cover.store_bureau

  - alias: ðŸªŸ  Open living room blind with switch
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_open_close_switch_2
          event: 1002
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_remote_control
          event: 2002
    action:
      service: cover.open_cover
      entity_id:
        - cover.window_covering_device_25
  - alias: ðŸªŸ  Close living room blind with switch
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_open_close_switch_2
          event: 2002
      - platform: event
        event_type: deconz_event
        event_data:
          id: tradfri_remote_control
          event: 3002
    action:
      service: cover.close_cover
      entity_id:
        - cover.window_covering_device_25

  - alias: ðŸªŸ  Halfway close window blinds when it's too sunny
    trigger:
      - platform: numeric_state
        entity_id: sensor.lightlevel_70
        above: 20000
        for:
          minutes: 2
    action:
      service: cover.set_cover_position
      entity_id:
        - cover.windows
      data:
        position: 50

  - alias: ðŸªŸ  Re-open windows when it gets darker
    trigger:
      - platform: numeric_state
        entity_id: sensor.lightlevel_70
        below: 20000
        for:
          minutes: 2
    action:
      service: cover.open_cover
      entity_id:
        - cover.windows

cover:
  # Custom device for controlling velux exterior blinds:
  # https://github.com/reefab/homeassistant-velux
  - platform: mqtt
    name: "Velux Mezzanine"
    command_topic: "cmnd/velux/Backlog"
    payload_open: "power2 off; power1 on; delay 1500"
    payload_close: "power1 off; power2 on; delay 320"
    payload_stop: "power1 off; power2 off"
    availability_topic: "tele/velux/LWT"
    payload_available: "Online"
    payload_not_available: "Offline"
  - platform: group
    name: windows
    entities:
      - cover.window_covering_device_25
      - cover.store_bureau
  - platform: group
    name: skylights
    entities:
      - cover.velux_mezzanine
      - cover.bedroom_blind

homeassistant:
  customize:
    cover.window_covering_device_25:
      friendly_name: "Store Salon"
      device_class: 'blind'
    cover.store_bureau:
      device_class: 'blind'
    cover.bedroom_blind:
      device_class: 'blind'
      friendly_name: "Store Chambre"
    cover.velux_mezzanine:
      device_class: 'blind'
